<?php

include '../src/config/Database.php';
include 'OpenAI.php';

class VulnerabilityAnalyzer
{
    private $conn;

    public function __construct($dbConnection)
    {
        $this->conn = $dbConnection;
    }

    public function analyzeApplication($applicationData)
    {
        foreach ($applicationData as $data) {
            if ($this->isVulnerable($data)) {
                $this->storeVulnerability($data);
            }
        }
    }

    private function isVulnerable($data)
    {
        return $this->isSQLInjection($data['input']) ||
               $this->isXSS($data['input']) ||
               $this->isFileUploadVulnerability($data['file']);
    }

    // Check for SQL Injection vulnerability
    private function isSQLInjection($input)
    {
        // Simple SQL Injection detection (replace with more comprehensive checks)
        $patterns = [
            '/union.*select/i',
            '/select.*from/i',
            '/drop.*table/i'
        ];

        foreach ($patterns as $pattern) {
            if (preg_match($pattern, $input)) {
                return true;
            }
        }
        return false;
    }

    // Check for Cross-Site Scripting (XSS) vulnerability
    private function isXSS($input)
    {
        // Simple XSS detection (replace with more comprehensive checks)
        $patterns = [
            '/<script.*>/i',
            '/<img.*onerror=.*>/i',
            '/<iframe.*>/i'
        ];

        foreach ($patterns as $pattern) {
            if (preg_match($pattern, $input)) {
                return true;
            }
        }
        return false;
    }

    private function isFileUploadVulnerability($file)
    {
        $allowedExtensions = ['jpg', 'png', 'pdf', 'doc'];
        $fileExtension = pathinfo($file['name'], PATHINFO_EXTENSION);

        return !in_array($fileExtension, $allowedExtensions);
    }

    private function storeVulnerability($data)
    {
        $query = "INSERT INTO detected_vulnerabilities (vulnerability_type, details, detection_time) 
                  VALUES (:vulnerability_type, :details, :detection_time)";
        $stmt = $this->conn->prepare($query);
        $stmt->bindParam(':vulnerability_type', $data['type']);
        $stmt->bindParam(':details', json_encode($data['details']));
        $stmt->bindParam(':detection_time', date('Y-m-d H:i:s'));
        $stmt->execute();

        $this->logVulnerability($data);
    }

    private function logVulnerability($data)
    {
        $logEntry = "Detected Vulnerability: Type: " . $data['type'] . 
                    ", Details: " . json_encode($data['details']) . 
                    ", Detected at: " . date('Y-m-d H:i:s') . PHP_EOL;

        file_put_contents('../logs/detected_vulnerabilities.log', $logEntry, FILE_APPEND);
    }

    public function getAllDetectedVulnerabilities()
    {
        $query = "SELECT * FROM detected_vulnerabilities ORDER BY detection_time DESC";
        $stmt = $this->conn->prepare($query);
        $stmt->execute();

        return $stmt->fetchAll(PDO::FETCH_ASSOC);
    }
}